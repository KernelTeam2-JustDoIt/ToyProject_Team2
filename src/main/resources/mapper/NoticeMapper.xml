<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.team2.mapper.NoticeMapper">


    <!-- ë©”ì¸ ë°°ë„ˆì— ë…¸ì¶œë  ë©”ì¸ ê³µì§€ 1ê±´ ê°€ì ¸ì˜¤ê¸° -->
    <select id="getMainNotice" resultType="com.team2.dto.notice.NoticeDTO">
        SELECT
            NOTICE_ID AS noticeId,
            WRITER_ADMIN_ID AS writerAdminId,
            NOTICE_TITLE AS title,
            NOTICE_DETAIL AS content,
            POSTED_AT AS postedAt,
            UPDATED_AT AS updatedAt,
            UPDATED_BY AS updatedBy,
            NOTICE_STATUS AS noticeStatus,
            IS_MAIN AS isMain,
            PRIORITY AS priority,
            IS_NEED_PIN AS isNeedPin,
            VIEW_COUNT AS viewCount
        FROM NOTICE
        WHERE IS_MAIN = 1
          AND NOTICE_STATUS = 'ACT'
        ORDER BY POSTED_AT DESC
            LIMIT 1
    </select>




    <select id="getNoticeDetail" parameterType="int" resultType="com.team2.dto.notice.NoticeDTO">
        SELECT
            NOTICE_ID AS noticeId,
            WRITER_ADMIN_ID AS writerAdminId,
            NOTICE_TITLE AS title,
            NOTICE_DETAIL AS content,
            POSTED_AT AS postedAt,
            UPDATED_AT AS updatedAt,
            UPDATED_BY AS updatedBy,
            NOTICE_STATUS AS noticeStatus,
            IS_MAIN AS isMain,
            PRIORITY AS priority,
            IS_NEED_PIN AS isNeedPin,
            VIEW_COUNT AS viewCount
        FROM NOTICE
        WHERE NOTICE_ID = #{noticeId}
    </select>

    <!-- ê³µì§€ì‚¬í•­ ë“±ë¡ -->
    <insert id="insertNotice" parameterType="com.team2.dto.notice.NoticeDTO" useGeneratedKeys="true" keyProperty="noticeId">
        INSERT INTO NOTICE
        (WRITER_ADMIN_ID, NOTICE_TITLE, NOTICE_DETAIL, IS_MAIN, IS_NEED_PIN, PRIORITY, NOTICE_STATUS, POSTED_AT)
        VALUES
            (#{writerAdminId}, #{title}, #{content}, #{isMain}, #{isNeedPin}, #{priority}, #{noticeStatus}, NOW())
    </insert>

    <!--ë©”ì¸ë…¸ì¶œ ê³µì§€ ìž‘ì„±ì‹œ ê¸°ì¡´ ë…¸ì¶œê³µì§€ ë¹„í™œì„±-->
    <update id="unsetMainNotice">
        UPDATE NOTICE
        SET IS_MAIN = 0
        WHERE IS_MAIN = 1
    </update>

    <!-- ê³µì§€ì‚¬í•­ ìˆ˜ì • -->
    <update id="updateNotice" parameterType="com.team2.dto.notice.NoticeDTO">
        UPDATE NOTICE
        SET
            NOTICE_TITLE = #{title},
            NOTICE_DETAIL = #{content},
            UPDATED_AT = #{updatedAt},
            UPDATED_BY = #{updatedBy},
            NOTICE_STATUS = #{noticeStatus},
            IS_MAIN = #{isMain},
            PRIORITY = #{priority},
            IS_NEED_PIN = #{isNeedPin}
        WHERE NOTICE_ID = #{noticeId}
    </update>

    <!-- ê³µì§€ì‚¬í•­ ì‚­ì œ DBì‚­ì œ ì•ˆí•˜ê³  ìƒíƒœ ì—…ë°ì´íŠ¸ë¡œ ë·°ì— í‘œê¸° ì•ˆí•˜ê¸° ìœ„í•¨ -->
    <update id="noticeDeleted">
        UPDATE NOTICE
        SET NOTICE_STATUS = 'DEL',
            UPDATED_AT = NOW(),
            UPDATED_BY = #{adminId}
        WHERE NOTICE_ID = #{noticeId}
    </update>

    <!-- ì „ì²´ ê³µì§€ ê°œìˆ˜ ì¡°íšŒ - getNoticeListì™€ ë™ì¼í•œ ì¡°ê±´ ì ìš© -->
    <select id="countNotices" parameterType="map" resultType="int">
        SELECT COUNT(*)
        FROM NOTICE
        <where>
            <!-- ðŸ”¥ ì¶”ê°€: getNoticeListì™€ ë™ì¼í•œ ì¡°ê±´ -->
            IS_NEED_PIN = 0 AND IS_MAIN = 0

            <choose>
                <when test="isAdmin == false">
                    AND NOTICE_STATUS = 'ACT'
                </when>
                <otherwise>
                    AND NOTICE_STATUS != 'DEL'
                </otherwise>
            </choose>

            <if test="keyword != null and keyword != ''">
                AND (
                NOTICE_TITLE LIKE CONCAT('%', #{keyword}, '%')
                OR NOTICE_DETAIL LIKE CONCAT('%', #{keyword}, '%')
                )
            </if>
        </where>
    </select>


    <!-- ìƒë‹¨ ê³ ì • ê³µì§€ (ë©”ì¸ê³µì§€ + ìƒë‹¨ê³µì§€) -->
    <select id="getPinnedNotices" resultType="com.team2.dto.notice.NoticeDTO">
        SELECT
            NOTICE_ID AS noticeId,
            WRITER_ADMIN_ID AS writerAdminId,
            NOTICE_TITLE AS title,
            NOTICE_DETAIL AS content,
            POSTED_AT AS postedAt,
            UPDATED_AT AS updatedAt,
            UPDATED_BY AS updatedBy,
            NOTICE_STATUS AS noticeStatus,
            IS_MAIN AS isMain,
            PRIORITY AS priority,
            IS_NEED_PIN AS isNeedPin,
            VIEW_COUNT AS viewCount
        FROM NOTICE
        WHERE (IS_MAIN = 1 OR IS_NEED_PIN = 1)
          AND NOTICE_STATUS = 'ACT'
          AND NOTICE_STATUS != 'DEL'
        ORDER BY PRIORITY ASC, POSTED_AT DESC
    </select>




    <!-- âœ… ì¼ë°˜ ê³µì§€ ëª©ë¡: IS_NEED_PIN = 0 (ê³ ì •ë˜ì§€ ì•Šì€ ê³µì§€ ì „ìš©) -->
    <select id="getNoticeList" parameterType="map" resultType="com.team2.dto.notice.NoticeDTO">
        SELECT
        NOTICE_ID AS noticeId,
        WRITER_ADMIN_ID AS writerAdminId,
        NOTICE_TITLE AS title,
        NOTICE_DETAIL AS content,
        POSTED_AT AS postedAt,
        UPDATED_AT AS updatedAt,
        UPDATED_BY AS updatedBy,
        NOTICE_STATUS AS noticeStatus,
        IS_MAIN AS isMain,
        PRIORITY AS priority,
        IS_NEED_PIN AS isNeedPin,
        VIEW_COUNT AS viewCount
        FROM NOTICE
        WHERE IS_NEED_PIN = 0
        AND IS_MAIN = 0
        <if test="isAdmin == false">
            AND NOTICE_STATUS = 'ACT'
        </if>
        <if test="isAdmin == true">
        AND NOTICE_STATUS != 'DEL'
    </if>
        <if test="keyword != null and keyword.trim() != ''">
            AND (NOTICE_TITLE LIKE CONCAT('%', #{keyword}, '%')
            OR NOTICE_DETAIL LIKE CONCAT('%', #{keyword}, '%'))
        </if>
        ORDER BY POSTED_AT DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>
<!--ì¡°íšŒìˆ˜ ì¦ê°€ ì¿¼ë¦¬ -->
    <update id="updateViewCount" parameterType="int">
        UPDATE NOTICE
        SET VIEW_COUNT = VIEW_COUNT + 1
        WHERE NOTICE_ID = #{noticeId}
    </update>


    <!-- ê³µì§€ì‚¬í•­ ìƒì„¸ í•˜ë‹¨ì— ì´ì „ê¸€ ë‹¤ìŒê¸€ -->
    <!-- âœ… ì´ì „ê¸€ -->
    <select id="findPreviousNotice" resultType="com.team2.dto.notice.NoticeDTO">
    <![CDATA[
        SELECT notice_id, NOTICE_TITLE AS title
        FROM notice
        WHERE notice_id < #{noticeId}
          AND notice_status != 'DEL'
        ORDER BY notice_id DESC
            LIMIT 1
        ]]>
</select>

    <!-- âœ… ë‹¤ìŒê¸€ -->
    <select id="findNextNotice" resultType="com.team2.dto.notice.NoticeDTO">
    <![CDATA[
        SELECT notice_id, NOTICE_TITLE AS title
        FROM notice
        WHERE notice_id > #{noticeId}
          AND notice_status != 'DEL'
        ORDER BY notice_id ASC
            LIMIT 1
        ]]>
</select>




</mapper>
